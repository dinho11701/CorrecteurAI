<!-- correction.html -->
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correction de Texte</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Oswald:wght@300&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
    crossorigin="anonymous"></script>

    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='stylesecond.css') }}">

    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">


</head>

<body>
    <!-- bootstrap imports -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>



    <nav class="navbar  bg-primary justify-content-between">
        <img src="https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=1012,h=233,fit=crop/mP4No6gyxPuVqkRL/logo-solution-e-learning-noir-YZ9Xqxg4w5SEoJo8.png"  class="logo-style">
        <a class="navbar-brand rubikStyle" style="color :white ; margin-left : 2% ; font-size: 32px;">Correcteur AI</a>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#myModal"
            style="align-items: center ; margin-top: 0; margin-right : 2% ;text-decoration: underline;">
            Mode d'emploi
        </button>
    </nav>
    <div id="secondNavbarContainer">
        <ul id="secondNavbar">
            <li>Tuteur IA</li>
            <li>Correcteur IA</li>
            <li>Safe IA</li>
            <li>Assistant IA</li>
        </ul>
    </div>
    <div class="zone">
        <div class="main-content2">
            <div id="alertPlaceholder" class="mb-3"></div>
            <form id="penaltyForm" action="javascript:void(0);" method="post">
                <div class="allpenaltiesBoxes">

                <h4 id="titleCorrection">Barème</h4>

                <div class="bareme-container">

                <div class="penalité_container">
                    <div class = "peno">
                        <div class = "little-blue-cube"></div>
                        <div class ="penalité">Pénalité conjugaison&nbsp; </div>
                        <input type="number" step="any" class="form-control" name="conjugaison_penalité" placeholder="Nombre entier ou décimal" value=1>
                    </div>
                    <!-- <input type="number" step="any" class="form-control" name="conjugaison_penalité" placeholder="Nombre entier ou décimal" value="1"> -->
                </div>
                <div class="penalité_container">
                    <div class = "peno">
                        <div class = "little-red-cube"></div>
                        <div class ="penalité">Pénalité orthographe&nbsp; </div>
                        <input type="number" step="any" class="form-control" name="orthographe_penalité" placeholder="Nombre entier ou décimal" value=1>
                    </div>
                    <!-- <input type="number" step="any" class="form-control" name="orthographe_penalité" placeholder="Nombre entier ou décimal" value="1"> -->
                </div>
                <div class="penalité_container">
                    <div class = "peno">
                        <div class = "little-green-cube"></div>
                        <div class ="penalité">Pénalité grammaire&nbsp; </div>
                        <input type="number" step="any" class="form-control" name="grammaire_penalité" placeholder="Nombre entier ou décimal" value=1>
                    </div>
                    <!-- <input type="number" step="any" class="form-control" name="grammaire_penalité" placeholder="Nombre entier ou décimal" value="1"> -->
                </div>
                    <button type="submit" class="btn btn-orange calculPenalty">Calculer pénalités <i class="bi bi-list-ul"></i></button>

            </div>
            </form>
            </div>

            <div class="content">
                <div id="text" contenteditable="false" class="editable-textarea2">
                    <!-- Ici, on parcourt les phrases et on ajoute une balise span avec la classe 'error' pour celles qui contiennent des fautes -->
                    {% for phrase in phrases %}
                    <span class="{{ 'error' if phrase.fautes else '' }}"
                    data-typeErreur="{{ phrase.fautes|map(attribute='typeErreur')|join('|') if phrase.fautes else '' }}"
                    data-description="{{ phrase.fautes|map(attribute='descriptionErreur')|join('|') if phrase.fautes else '' }}"
                    data-nb-erreurs="{{ phrase.nb_erreurs }}"
                    {% if phrase.fautes %}onclick="afficherPopup({{ loop.index0 }},event)" {% endif %}>
                    {{ phrase.contenu }}
                    </span>
                    {% endfor %}
                </div>
            </div>

            <div id="errorPopup" class="popup" style="display:none;">
                <span class="close" onclick="fermerPopup()">&times;</span>
                <div id="errorContent"></div>
            </div>
            
            <form action="/" method="post">
                <button type="submit" class="btn btn-orange btn-lg correction-autre">Corriger un autre texte <i class="bi bi-box-arrow-left"></i></button>
            </form>
        </div>
        <button id="invisiblebutton">
            Corrections
            <span class="arrow-icon">&larr;</span>
        </button>
        <div id="banniere">
           
            <div class="offcanvas-body">
                <div class="allpenaltiesBoxes">
                    <h4 id="titleCorrection1">Statistiques</h4>

                    <h5>{{resultat_sans_faute}}</h5>
                    <div class="paragraphe">Nombre de faute de conjugaison : <span id="nb_erreurs_conjugaison">{{nb_erreurs_conjugaison}}</span></br> <strong>Penalité conjugaison :</strong>
                        -<span id="penalite_conjugaison">{{penalite_conjugaison}}</span></div>
                    <div class="progress" style="height: 3%">
                        <div id="progress_bar_conjugaison" class="progress-bar bg-primary"  role="progressbar" aria-valuenow="{{ ratio_conjugaison }}"
                        aria-valuemin="0" aria-valuemax="100" style="width:{{ ratio_conjugaison }}%">
                            {{ ratio_conjugaison }}%
                        </div>
                    </div>
                    <div class="paragraphe">Nombre de faute d'orthographe : <span id="nb_erreurs_orthographe">{{nb_erreurs_orthographe}}</span></br> <strong>Penalité orthographe :</strong>
                        -<span id="penalite_orthographe">{{penalite_orthographe}}</span>
                    </div>
                    <div class="progress" style="height: 3%">
                        <div id="progress_bar_orthographe"class="progress-bar bg-danger"  role="progressbar" aria-valuenow="{{ ratio_orthographe }}"
                            aria-valuemin="0" aria-valuemax="100" style="width:{{ ratio_orthographe }}%">
                            {{ ratio_orthographe }}%
                        </div>
                    </div>
                    <div class="paragraphe">Nombre de faute de grammaire : <span id="nb_erreurs_grammaire">{{nb_erreurs_grammaire}}</span></br> <strong>Penalité grammaire :</strong> 
                        -<span id="penalite_grammaire">{{penalite_grammaire}}</span>
                    </div>
                    <div class="progress" style="height: 3%">
                        <div id="progress_bar_grammaire" class="progress-bar bg-success"  role=" progressbar" aria-valuenow="{{ ratio_grammaire }}"
                            aria-valuemin="0" aria-valuemax="100" style="width:{{ ratio_grammaire }}%">
                            {{ ratio_grammaire }}%
                        </div>
                    </div>
                    <div class="penalty-container">
                        <h4 id="totalPenalty"><u>Penalité totale :</u> -<span id="penalite_totale">{{penalite_totale}}</span></h4>
                    </div>
                
                
                <div class="accordion" id="accordionExample">
                    <div class="accordion-item">
                      <h2 class="accordion-header" id="headingOne">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                          <div class ="accordeon">Bonne pratique</div>
                          
                        </button>
                      </h2>
                      <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                          <!-- Affiche le premier commentaire de la liste -->
                          {{ liste_commentaire[0] }}
                        </div>
                      </div>
                    </div>
                    <div class="accordion-item">
                      <h2 class="accordion-header" id="headingTwo">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                          A améliorer
                          <!-- <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle-fill" viewBox="0 0 16 16">
                            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293z"/>
                          </svg> -->
                        </button>
                      </h2>
                      <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                          <!-- Affiche le deuxième commentaire de la liste -->
                          {{ liste_commentaire[1] }}
                        </div>
                      </div>
                    </div>
                    <div class="accordion-item">
                      <h2 class="accordion-header" id="headingThree">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                <div class = "accordeon">Remarques</div>
                                <!-- <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-circle" viewBox="0 0 16 16">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                                    <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/>
                                </svg> -->
                        </button>
                      </h2>
                      <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                          <!-- Affiche le troisième commentaire de la liste -->
                          {{ liste_commentaire[2] }}
                        </div>
                      </div>
                    </div>
                  </div>
                  <form action="/download-correction" method="post">
                    <input type="hidden" id="penalite_grammaire_hidden" name="penalite_grammaire" value="{{penalite_grammaire}}">
                    <input type="hidden" id="penalite_orthographe_hidden" name="penalite_orthographe" value="{{penalite_orthographe}}">
                    <input type="hidden" id="penalite_conjugaison_hidden" name="penalite_conjugaison" value="{{penalite_conjugaison}}">
                    <input type="hidden" name="nb_erreurs_grammaire" value="{{nb_erreurs_grammaire}}">
                    <input type="hidden" name="nb_erreurs_orthographe" value="{{nb_erreurs_orthographe}}">
                    <input type="hidden" name="nb_erreurs_conjugaison" value="{{nb_erreurs_conjugaison}}">
                    <input type="hidden" id="penalite_totale_hidden" name="penalite_totale" value="{{penalite_totale}}">
                    <input type="hidden" name="phrases" value="{{phrases}}">
                    <button type="submit" class="btn btn-orange downloadButton">Télécharger la correction <i class="bi bi-file-earmark-arrow-down"></i></button>
                </form>
                  </div>
                
            </div>
        </div>
    </div>
    <div class="modal" id="myModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Mode d'emploi</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body">
                    Rentrer votre texte à corriger et appuyer sur le bouton "corriger".
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>


    <script>

        $('#penaltyForm').submit(function(e) {
            e.preventDefault(); // Empêche la soumission normale du formulaire
            var form = $(this);
            var url = '/update_penalties'; // L'URL de la nouvelle route
        
            $.ajax({
                type: "POST",
                url: url,
                data: form.serialize(), // Sérialise les données du formulaire
                success: function(response) {
                    // Mise à jour des valeurs des pénalités dans le offcanvas-body
                    $('#penalite_conjugaison').text(response.penalite_conjugaison_total.toFixed(2));
                    $('#penalite_orthographe').text(response.penalite_orthographe_total.toFixed(2));
                    $('#penalite_grammaire').text(response.penalite_grammaire_total.toFixed(2));
                    $('#penalite_totale').text(response.penalite_totale.toFixed(2));
        
                    // Optionnellement, mettre à jour les ratios pour les barres de progression si cela s'applique
                    var ratioConjugaison = (response.penalite_conjugaison_total / response.penalite_totale * 100).toFixed(2);
                    var ratioOrthographe = (response.penalite_orthographe_total / response.penalite_totale * 100).toFixed(2);
                    var ratioGrammaire = (response.penalite_grammaire_total / response.penalite_totale * 100).toFixed(2);
        
                    $('#progress_bar_conjugaison').css('width', ratioConjugaison + '%').attr('aria-valuenow', ratioConjugaison).text(ratioConjugaison + '%');
                    $('#progress_bar_orthographe').css('width', ratioOrthographe + '%').attr('aria-valuenow', ratioOrthographe).text(ratioOrthographe + '%');
                    $('#progress_bar_grammaire').css('width', ratioGrammaire + '%').attr('aria-valuenow', ratioGrammaire).text(ratioGrammaire + '%');
        
                    // Mettre à jour les valeurs dans le formulaire de téléchargement
                    $('#penalite_grammaire_hidden').val(response.penalite_grammaire_total.toFixed(2));
                    $('#penalite_orthographe_hidden').val(response.penalite_orthographe_total.toFixed(2));
                    $('#penalite_conjugaison_hidden').val(response.penalite_conjugaison_total.toFixed(2));
                    $('#penalite_totale_hidden').val(response.penalite_totale.toFixed(2));
        
                    // Afficher une notification Bootstrap
                    showBootstrapAlert('Les pénalités ont été mises à jour avec succès.', 'success');
        
                    // Soumettre le formulaire de téléchargement
                    $('#downloadForm').submit();
                }
            });
        });

        // Fonction pour afficher une alerte Bootstrap
        function showBootstrapAlert(message, type) {
            var alertHtml = '<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' +
                                message +
                                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                            '</div>';
            $('#alertPlaceholder').html(alertHtml);
        }
    </script>



</body>

</html>